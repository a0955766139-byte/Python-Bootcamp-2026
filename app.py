import streamlit as st
import database_manager as db #å°æ¥è³‡æ–™åº«
import pandas as pd
import numpy as np

#--- 1. è¨­å®šç¶²é é…ç½® (é€™è¡Œè¦æ“ºç¬¬ä¸€è¡Œ) ---
st.set_page_config(page_title="å–¬éˆå¿ƒå­¸", page_icon="ğŸ”®")

#--- 2. æ¨™é¡Œå€å¡Š ---
st.title("å–¬éˆæ–‡åŒ–Â·ä¹èƒ½é‡å¿ƒå­¸ ğŸ”®")
st.caption("æ­¡è¿å›åˆ°å–¬éˆå¿ƒå­¸ï¼Œç·´ç¿’è¦ºå¯Ÿèˆ‡é¡¯åŒ–çš„æ—¥å¸¸ã€‚")

#---3. æ¯æ—¥æé†’(æ¨¡ç–‘ç…§ç‰‡ä¸­çš„é€šçŸ¥å€) ---
with st.expander("ğŸ”” ä»Šæ—¥æé†’ (é»æ“Šå±•é–‹)", expanded=True):
    st.info("API å·²é€£ç·šæˆåŠŸï¼Œå¯ä»¥é–‹å§‹ä½¿ç”¨å…­å¤§ä¸»åŠŸèƒ½ã€‚")
    st.write("ğŸŒŸ ä»Šæ—¥å®‡è¨Šæ¯ : ç›¸ä¿¡ä½ çš„ç›´è¦ºï¼Œè²¡å¯Œæ­£åœ¨é è¿‘!")

st.divider() #ç•«ä¸€æ¢åˆ†éš”ç·š

# --- 4. æ ¸å¿ƒåŠŸèƒ½å€(ä½¿ç”¨Columns åš 2x3 çš„ç¶²æ ¼æ’ç‰ˆ) ---
# å»ºç«‹å…©æ¬„ (col1, col2)
col1, col2 = st.columns(2)

with col1:
    st.subheader("ğŸƒ æ¯æ—¥æŠ½ç‰Œ")
    st.write("ç”¨ä¸€å¼µç‰Œçœ‹è¦‹ç•¶ä¸‹è¨Šæ¯")
    if st.button("é–‹å§‹æŠ½ç‰Œ"):
        st.toast("æŠ½ç‰ŒåŠŸèƒ½é–‹ç™¼ä¸­...ğŸ”®")

with col2:
    st.subheader("ğŸ”¢ ä¹èƒ½é‡å¿ƒå­¸")
    st.write("ç”Ÿå‘½éˆæ•¸ x ç¾ä»£å¿ƒç†å­¸")
    if st.button("æŸ¥çœ‹å‘½ç›¤"):
        st.toast("å‘½ç›¤è¼‰å…¥ä¸­...ğŸ“Š")

st.write("---") # åˆ†éš”è·

col3, col4 = st.columns(2)

with col3:
        st.subheader("ğŸ““ é¡¯åŒ–æ—¥è¨˜")
        st.write("å¯«ä¸‹ä»Šå¤©çš„è¦ºå¯Ÿèˆ‡é¡¯åŒ–")
        
        # --- 1. å¯«æ—¥è¨˜çš„åŠŸèƒ½å€ (ç”¨æ‘ºç–Šé¸å–®æ”¶èµ·ä¾†ï¼Œæ¯”è¼ƒä¸ä½”ç©ºé–“) ---
        with st.expander("âœï¸ é»æ“Šé€™è£¡å¯«æ—¥è¨˜", expanded=False):
            with st.form("mini_diary_form", clear_on_submit=True):
                # å› ç‚ºæ¬„ä½è¼ƒçª„ï¼Œæ¨™é¡Œç°¡çŸ­ä¸€é»
                mood = st.selectbox("é »ç‡", ["ğŸ¥° è¶…é–‹å¿ƒ", "ğŸ”¥ å……æ»¿èƒ½é‡", "ğŸ˜Œ å¹³éœ", "ğŸ˜” ä½è½", "ğŸŒŸ å……æ»¿å¸Œæœ›"])
                content = st.text_area("é¡¯åŒ–å…§å®¹...")
                
                submitted = st.form_submit_button("ğŸš€ ç™¼é€")
                
                if submitted and content:
                    db.save_diary_entry(content, mood) # å‘¼å«å¾Œç«¯å­˜æª”
                    st.success("å·²ç™¼é€ï¼")
                    st.rerun() # å¼·åˆ¶é‡æ–°æ•´ç†ï¼Œè®“ä¸‹é¢çš„åˆ—è¡¨ç«‹åˆ»æ›´æ–°

        # --- 2. çœ‹æ—¥è¨˜çš„åŠŸèƒ½å€ (ç›´æ¥é¡¯ç¤ºæœ€è¿‘çš„ç´€éŒ„) ---
        st.divider() # ç•«ä¸€æ¢åˆ†éš”ç·š
        st.caption("ğŸ“– æœ€è¿‘çš„ 3 ç­†ç´€éŒ„") # ç”¨ caption å­—é«”æ¯”è¼ƒå°ï¼Œé©åˆçª„æ¬„ä½

        # å‘¼å«å¾Œç«¯æ‹¿è³‡æ–™
        logs = db.get_all_diaries()

        if not logs:
            st.info("å°šæœªæœ‰ç´€éŒ„")
        else:
            # æˆ‘å€‘åªé¡¯ç¤ºæœ€æ–°çš„ 3 ç­†å°±å¥½ï¼Œä»¥å…æŠŠé é¢æ‹‰å¤ªé•·
            for row in logs[:3]: 
                # row[3]æ˜¯æ™‚é–“, row[2]æ˜¯å¿ƒæƒ…, row[1]æ˜¯å…§å®¹
                # æˆ‘å€‘æŠŠæ™‚é–“åªå–å‰ 10 å€‹å­— (2026-01-08)ï¼ŒæŠŠç§’æ•¸å»æ‰æ¯”è¼ƒä¹¾æ·¨
                date_str = row[3][:10] 
                
                # é¡¯ç¤ºä¸€å€‹å°å€å¡Š
                st.markdown(f"**{date_str}** | {row[2]}")
                st.text(row[1]) # ç”¨ text é¡¯ç¤ºå…§å®¹
                st.markdown("---") # å°åˆ†éš”ç·š

with col4:
    st.subheader("ğŸ§ å€‹æ¡ˆ & èª²ç¨‹")
    st.write("ä¸€å°ä¸€è§£æèˆ‡é€²éšèª²ç¨‹")
    if st.button("é ç´„è«®è©¢"):
        st.link_button("å‰å¾€é ç´„", "https://calendar.google.com") # ç¯„ä¾‹é€£çµ

st.write("---") # åˆ†éš”è·

col5, col6 = st.columns(2)

with col5:
    st.subheader("ğŸ›’ å•†åŸ")
    st.write("æ›¸ç±ã€èª²ç¨‹ã€æ•¸å­—å·¥å…·")
    st.button("å‰å¾€å•†åŸ")

with col6:
    st.subheader("ğŸ‘¤ æœƒå“¡ä¸­å¿ƒ")
    st.write("å€‹äººè³‡æ–™ & è¨­å®š")
    st.button("ç®¡ç†å¸³æˆ¶")

# --- 5. Day 9 é‡é»ï¼šæ•¸æ“šè¦–è¦ºåŒ– (Data Visualization) ---
st.divider()
st.header("ğŸ“Š æœ¬é€±èƒ½é‡è¶¨å‹¢ (Day 9 ç·´ç¿’)")
st.write("é€™æ˜¯ä½ æœ¬é€±çš„ã€Œè¦ºå¯ŸæŒ‡æ•¸ã€èˆ‡ã€Œé¡¯åŒ–é€²åº¦ã€ï¼š")

# é€™è£¡æˆ‘å€‘ç”¨ Python ç•«ä¸€å€‹ç°¡å–®çš„æŠ˜ç·šåœ–
chart_data = pd.DataFrame(
    np.random.randn(7, 2) + [10, 5],  # éš¨æ©Ÿç”¢ç”Ÿæ•¸æ“šæ¨¡æ“¬
    columns=['è¦ºå¯ŸæŒ‡æ•¸', 'é¡¯åŒ–èƒ½é‡']
)

# Streamlit ç•«åœ–åªéœ€ä¸€è¡ŒæŒ‡ä»¤ï¼
st.line_chart(chart_data)

st.caption("å°æç¤ºï¼šè©¦è‘—æŠŠæ»‘é¼ ç§»åˆ°åœ–è¡¨ä¸Šï¼Œå¯ä»¥çœ‹åˆ°è©³ç´°æ•¸å­—å–”ï¼")